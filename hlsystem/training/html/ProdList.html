<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Reset CSS -->
    <link href="https://cdn.jsdelivr.net/npm/reset-css@5.0.2/reset.min.css" rel="stylesheet">
    <!-- Google Noto Sans Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap" rel="stylesheet">
    <!-- Fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <!-- vue version 2-->
    <script src="https://unpkg.com/vue@2"></script>	

    <!-- Bilboard Chart(https://naver.github.io/billboard.js) -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="./js/billboard.js"></script>
    <link rel="stylesheet" href="./css/billboard.css">
    <!--jquery-->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- 畑밸틶��� Bootstrap 占쎌돦 CSS 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

        <!-- Imported styles on this page -->
    <link rel="stylesheet" href="./css/datatables.css">
    <link rel="stylesheet" href="./css/prodlist.css">
    
    <title>상품정보관리</title>
</head>
    
<body>
    <div class="flex-column flex-gap-10" id="vueapp">
        <div class="flex flex-100">
            <div class="flex-wrap flex-66 flex flex-gap-10 flex-padding-10">   
                <div class="form-group flex-40">
                    <label class="fix-width-33">상품명:</label>
                    <input class="form-control" v-model="prod_nm" value="" />
                </div>
                <div class="form-group flex-40">
                    <label class="fix-width-33">가입대상:</label>
                    <select v-model="sbstg_ty_cd" class="form-control">
                        <option value="0">전체</option>
                        <option value="1">일반개인</option>
                        <option value="2">청년생활지원</option>
                    </select>
                </div>
                <div class="form-group flex-40">
                    <label class="fix-width-33">판매시작일:</label>
                    <input type="text" class="form-control" v-model="from_date" data-format="yyyy-mm-dd" style="width: 180px;">
                </div> 
                <div class="form-group flex-40">
                    <label class="fix-width-33">납입주기:</label>
                        <select v-model="pay_ty_cd" class="form-control">
                            <option value="">전체</option>
                            <option value="1">월납</option>
                            <option value="2">년납</option>
                            <option value="3">일시납</option>
                        </select>
                </div>
            </div>  
            <div class="flex-wrap flex-33 flex flex-center flex-gap-10 flex-padding-10">   
                <div class="form-group" style="width:45%;">
                    <button 
                    type="button" class="btn btn-blue btn-icon icon-left form-control " @click="getList(true)">
                        조건검색
                        <i class="entypo-search"></i>
                    </button>
    
                </div>
                <div class="form-group" style="width:45%;">
                    <button type="button" class="btn btn-blue btn-icon icon-left form-control" @click="getList(true)">
                        전체검색
                        <i class="entypo-search"></i>
                    </button>

                </div>
                <div class="form-group" style="width:45%">
                    <button type="button" class="btn btn-blue btn-icon icon-left form-control" @click="getList(true)">
                        전체검색
                        <i class="entypo-search"></i>
                    </button>

                </div>
  
            </div>
        </div>       
        <div class="flex flex-100 flex-padding-10 flex-gap-10" style="justify-content:flex-end;border: 1px solid #999999;">
            <button type="button" class="btn btn-blue btn-icon icon-left"  @click="popupPrint()">
                인쇄
                <i class="entypo-print"></i>
            </button>
            <button type="button" class="btn btn-orange btn-icon icon-left btn-small" @click="cf_movePage('/prod_mng/dtl')">
                등록
                <i class="entypo-plus"></i>
            </button>
        </div>
        <table class="table table-bordered datatable dataTable" id="grid_app" style="border: 1px solid #999999;">
        <thead>
            <tr class="replace-inputs">
                <th style="width: 4%;" class="center hidden-xs nosort"><input type="checkbox" id="allCheck" @click="all_check(event.target)"></th>
                <th style="width: 20%;" class="center sorting" @click="sortList(event.target)" sort_target="prod_nm">상품명</th>
                <th style="width: 10%;" class="center sorting" @click="sortList(event.target)" sort_target="sbstg_ty_cd_nm">가입대상</th>
                <th style="width: 13%;" class="center sorting" @click="sortList(event.target)" sort_target="ntsl_amt_min">최소가입금액</th>
                <th style="width: 13%;" class="center sorting" @click="sortList(event.target)" sort_target="ntsl_amt_max">최대가입금액</th>						
                <th style="width: 10%;" class="center sorting" @click="sortList(event.target)" sort_target="pay_ty_cd_nm">납입주기</th>			
                <th style="width: 10%;" class="center sorting" @click="sortList(event.target)" sort_target="prod_air_min">최소적용이율</th>	
                <th style="width: 10%;" class="center sorting" @click="sortList(event.target)" sort_target="prod_air_max">최대적용이율</th>							
                <th style="width: 10%;" class="center sorting" @click="sortList(event.target)" sort_target="int_tax_ty_cd_nm">이자과세</th>																
            </tr>
        </thead>
        <tbody>
            <tr v-for="item in dataList" style="cursor: pointer;">
                <td class="center">
                    <input type="checkbox" :data-idx="item.prod_cd" name="is_check" @click="onCheck">
                </td>
                <td class="left" @click="gotoDtl(item.prod_cd)">{{item.prod_nm}}</td>
                <td class="center" @click="gotoDtl(item.prod_cd)">{{item.sbstg_ty_cd_nm}}</td>
                <td class="right" @click="gotoDtl(item.prod_cd)" style="text-align: right;">{{item.ntsl_amt_min}}</td>
                <td class="right" @click="gotoDtl(item.prod_cd)" style="text-align: right;">{{item.ntsl_amt_max}}</td>
                <td class="center" @click="gotoDtl(item.prod_cd)">{{item.pay_ty_cd_nm}}</td>
                <td class="right" @click="gotoDtl(item.prod_cd)" style="text-align: right;">{{item.prod_air_min}}</td>
                <td class="right" @click="gotoDtl(item.prod_cd)" style="text-align: right;">{{item.prod_air_max}}</td>
                <td class="center" @click="gotoDtl(item.prod_cd)">{{item.int_tax_ty_cd_nm}}</td>													
            </tr>
        </tbody>
        </table>
    </div>
    <script>

        function setDatePicker() {
            setTimeout(
                    function(){
                        if($("#fromdtbtn").length == 1){
                            var $this = $(".datepicker2"),
                            opts = {
                                format: attrDefault($this, 'format', 'mm/dd/yyyy'),
                                daysOfWeekDisabled: attrDefault($this, 'disabledDays', ''),
                                startView: attrDefault($this, 'startView', 0),
                                rtl: rtl(),
                                todayBtn: true,
                                language : 'ko',
                                autoclose : true,
                                todayHighlight : true,
                            },
                            $n = $this.next(),
                            $p = $this.prev();
                            $this.datepicker(opts).on("changeDate",function(e){
                                var objID = e.currentTarget.id;
                                if(objID == 'fromdtbtn'){	//시작일시
                                    vueapp.from_date = e.date.format('yyyy-MM-dd')
                                }
                            });
                        } 
                    },
                    300
                );
        }
        setDatePicker();
        
        var todaystr = "${today}";							
        var today = todaystr.toDate();	
        
        var vueapp = new Vue({
            el : "#vueapp",
            data : {
                dataList : [],
                prod_nm : "",
                sbstg_ty_cd : "",
                pay_ty_cd : "",
                from_date : ""	
            },
            mounted : function(){
                var fromDtl = cf_getUrlParam("fromDtl");
                var pagingConfig = cv_sessionStorage.getItem("pagingConfig");		
                if("Y" === fromDtl && !cf_isEmpty(pagingConfig)){
                    cv_pagingConfig.pageNo = pagingConfig.pageNo;
                    cv_pagingConfig.orders = pagingConfig.orders;
                     
                    this.getList();
                } else {
                    cv_sessionStorage
                        .removeItem("pagingConfig")
                        .removeItem("params");
                    this.getList(true);
                }
            },
            methods : {
                getList : function(isInit){
        
                    cv_pagingConfig.func = this.getList;
                    
                    if(isInit === true){
                        cv_pagingConfig.pageNo = 1;
                        cv_pagingConfig.orders = [{target : "prod_nm", isAsc : false}];
                    }
                    
                    var params = {}
                    params = {
                        prod_nm : this.prod_nm,
                        sbstg_ty_cd : this.sbstg_ty_cd,
                        pay_ty_cd : this.pay_ty_cd,
                        from_date : this.from_date,
                    }
                    
                    cv_sessionStorage
                        .setItem('pagingConfig', cv_pagingConfig)
                        .setItem('params', params);
        
                    cf_ajax("/prod_mng/getListPaging", params, this.getListCB);
                },
                getListCB : function(data){
                     this.dataList = data.list;
                    for(var i=0; i<this.dataList.length; i++){
                        this.dataList[i].ntsl_amt_min = this.dataList[i].ntsl_amt_min.numformat();
                        this.dataList[i].ntsl_amt_max = this.dataList[i].ntsl_amt_max.numformat();
                    }
                    
                    cv_pagingConfig.renderPagenation("system");
                },
                gotoDtl : function(prod_cd){
                    var params = {
                            prod_cd : cf_defaultIfEmpty(prod_cd, ""),
                        }
                    cf_movePage("/prod_mng/dtl", params);
                },
                sortList : function(obj){
                    cf_setSortConf(obj, "prod_nm");
                    this.getList();
                },
                all_check : function(obj){
                    $('[name=is_check]').prop('checked',obj.checked);
                },
                onCheck : function(){
                    $("#allCheck").prop('checked',
                            $("[name=is_check]:checked").length === $("[name=is_check]").length
                    );
                },
                popupPrint : function(prod_cd){
                    var chkedList = $("[name=is_check]:checked");			 
                    if(chkedList.length == 0){
                        alert("출력할 대상을 선택하여 주십시오.");
                        return;
                    }
                    //check list 가져오기..
                    var dateCopyList = [];
                    var idx;
                    chkedList.each(function(i) {
                        idx = $(this).attr("data-idx");
                        dateCopyList.push(vueapp.dataList.getElementFirst("prod_cd", idx));
                    });			
                    
                    console.log(dateCopyList);		
                    
                    //출력팝업 띄우기
                    popup_print.init(dateCopyList);
                    $('#popup_print').modal('show');
                },
            },
        })
        
        var popup_print = new Vue({
            el : "#popup_print",
            data : {
                printInfo : {
                    prodCount : 0,
                    prodList : [],
                }
            },
            methods : {
                init : function(dateCopyList){
                    this.initInfo(dateCopyList);
                },
                initInfo : function(dateCopyList){
                    this.printInfo = {	
                        prodCount : dateCopyList.length,
                        prodList : dateCopyList,
                    };
                },
                print : function(){
                    const printArea = document.getElementById('printArea').innerHTML;
                    console.log(printArea);
                    
                     win = window.open(); 
                     self.focus();  
                     win.document.open();
                       
                     /*
                     1. div 안의 모든 태그들을 innerHTML을 사용하여 매개변수로 받는다.
                     2. window.open() 을 사용하여 새 팝업창을 띄운다.
                     3. 열린 새 팝업창에 기본 <html><head><body>를 추가한다.
                     4. <body> 안에 매개변수로 받은 printArea를 추가한다.
                     5. window.print() 로 인쇄
                     6. 인쇄 확인이 되면 팝업창은 자동으로 window.close()를 호출하여 닫힘
                     */
                     win.document.write('<html><head>');
                      
                     win.document.write('<link rel="stylesheet" href="/static_resources/system/js/datatables/datatables.css">');
                     win.document.write('<link rel="stylesheet" href="/static_resources/system/js/select2/select2-bootstrap.css">');
                     win.document.write('<link rel="stylesheet" href="/static_resources/system/js/select2/select2.css">');
                        
                     win.document.write('<title></title><style>');	
                     win.document.write('td.center {text-align: center;}');
                     win.document.write('th.center {text-align: center;}');
                     win.document.write('body {font-size: 14px;}');
                     win.document.write('</style></head><body>');
                     win.document.write(printArea);
                     win.document.write('</body></html>');
                     win.document.close();  
                     win.print();
                     win.close();
                },        
            }
        });
    </script>        
</body>
</html>